## 大纲

###### 什么是即时通讯

* 简单明了 -> 发送的信息能被实时接收 -> 核心重点

* 代表性产品 -> QQ、微信、游戏内的聊天 -> 生活中必不可少的一部分
* 优秀开发商代表 -> 腾讯、网易 
* 名不经传 -> 环信、e-link等

<br >

#### SDK

* Web、微信小程序
* 有意 -> 后端API -> 以免被忽悠

<br >

#### 提供的功能

* 仅仅发送实时接收 -> 自己都可以实现 -> 长轮询搞定
* 能搞那么好、那么出名 -> 独到之处

* 模式 -> 单聊、群聊
* 腾讯 -> 群聊细分(类型) 私有群、公开群、聊天室、音视频聊天室、在线成员广播大群
* 网易 -> 单聊、群聊、聊天室(需要登陆)

* 用户资料托管（关系）
* 消息推送 -> 客户端有自带
* 管理与监控 ->账号结构 ->  架构介绍
* 控制台 -> ID、密钥 -> 后台账号 -> 结构图
* 账号集成与登陆

![image-20191223115749832](https://qiniu-app.qtshe.com/image-20191223115749832.png)

![image-20191223100430399](https://qiniu-app.qtshe.com/image-20191223100430399.png)

<br >

#### 核心点

1. 作为即时通讯 -> 消息
   * 文本消息、图片消息、语音消息、视频消息、文件消息、地理位置消息、通知消息、提示消息、自定义消息(大赏、红包)
   * 疑问 -> 图片、语音、视频不都属于文件吗 -> 时常、大小、格式
   * 扩展 -> 消息、用户信息、群资料
   * 正常消息、离线消息、漫游消息（多端登陆）
   * 消息已读状态、已读上报、消息撤回 -> web不支持、腾讯已读上报假接口

2. 群组功能

   * 区别 -> 腾讯聊天室作为群的一种、网易分为NIM、chartRoom(聊天室)

   * 腾讯群

     私有群：适用于较为私密的聊天场景，群组资料不公开，只能通过邀请的方式加入，类似于微信群。
     公开群：适用于公开群组，具有较为严格的管理机制、准入机制，类似于 QQ 群。
     聊天室：群成员可以随意进出，组织较为松散，成员可以获取到本人进入聊天室前的聊天消息，人数上限6000。
     音视频聊天室：与聊天室类似，但群成员人数无上限，并且在 Web 端支持以游客身份接收聊天消息。
     在线成员广播大群：成员人数无上限，在 Web 端支持以游客身份接收群消息，适用于向 App 全体在线成员推送消息的场景

   * 网易群

     ![image-20191223134634027](https://qiniu-app.qtshe.com/image-20191223134634027.png)

   * 区别 -> 聊天室创建 -> 网易聊天室得后端创建

3. 实现模式

   * 腾讯 -> 使用长轮询
   * 网易 -> websocket、xhr-polling(comet)、flashsocket 三选一

4. emoji功能

5. 长轮询、轮询

<br >

#### 腾讯坑位

1. 被拉黑状态无法检测

   被拉黑后给对方发消息没有code值标示，只提示消息发送失败，失败的code值还会根据腾讯控制台的配置更改而改变

2. 消息已读状态是假字段

   C2C模式时看到官网中有写到 message里面有个字段isRead（Boolean false 是否已读），但是无论我使用什么样的方式拿到这个字段的值始终时1

3. 会话列表里面会存在发送失败的消息，但没有标识是发送失败的

   场景：A安卓用户，Bweb端用户，当我使用A将B拉黑后，B给A发送消息发送失败，这个逻辑正确
   问题：B给A发送端消息（发送失败的那条消息）不会记录到云端，但是在B的会话列表里面的lastMsg里面却可以看到这条记录

4. 已读上报功能为假

   web端不支持已读回执，不上报已读回执

5. 用户信息websdk不支持扩展

   场景：有一条会话，A(我，web端)和B(安卓端)，后端同学在B的用户信息上面做了自定义扩展字段
   问题：在通过A获取的会话列表里面的userProfile对象下并没有拿到相对应的扩展字段

